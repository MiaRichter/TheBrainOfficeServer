<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Sensor Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <style>
        body { font-family: Arial; margin:20px; background:#f4f4f4; }
        #sensorData, #portsList {
            background:#fff; padding:20px; border-radius:8px;
            box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-top:20px;
        }
        ul { list-style:none; padding:0; }
        li { padding:8px; background:#eee; margin:4px 0; border-radius:4px; cursor:pointer; }
        li:hover { background:#ddd; }
        .value { font-weight:bold; }
    </style>
</head>
<body>
<h1>Данные с сенсора</h1>

<div id="sensorData" style="display:none;">
    <p><strong>Температура:</strong> <span id="temperature" class="value"></span> °C</p>
    <p><strong>Влажность:</strong> <span id="humidity" class="value"></span> %</p>
    <p><strong>RFID:</strong> <span id="rfid" class="value"></span></p>
    <p><strong>Сервопривод:</strong> <span id="servo" class="value"></span></p>
</div>

<div id="portsList">
    <h3>Доступные USB-порты:</h3>
    <ul id="portsUl"></ul>
</div>

<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("http://mia.local:5000/sensorhub")
        .configureLogging(signalR.LogLevel.Information)
        .build();

    // Приходит каждое обновление списка портов
    connection.on("ReceiveSensorData", data => {
        document.getElementById("sensorData").style.display = "block";
        document.getElementById("temperature").textContent = data.temperature.toFixed(1);
        document.getElementById("humidity").textContent = data.humidity.toFixed(1);
        document.getElementById("rfid").textContent     = data.rfid || "Нет";
        document.getElementById("servo").textContent    = data.servo > 0 ? "ВКЛ" : "ВЫКЛ";
        console.log("Данные сенсора:", data);
    });

    async function start() {
        await connection.start();
        console.log("SignalR подключён");

        // Подписываемся на стрим портов
        const stream = connection.stream("StreamAvailablePorts");

        stream.subscribe({
            next: ports => {
                const ul = document.getElementById("portsUl");
                ul.innerHTML = "";
                ports.forEach(p => {
                    const li = document.createElement("li");
                    li.textContent = `/dev/ttyUSB${p}`;
                    li.onclick = () => connection.invoke("OpenPort", p);
                    ul.appendChild(li);
                });
                console.log("Порты:", ports);
            },
            error: err => console.error(err),
            complete: () => console.log("Стрим портов завершён")
        });
    }

    start().catch(err => console.error(err));
</script>
</body>
</html>
